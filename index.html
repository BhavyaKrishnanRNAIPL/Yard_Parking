<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>VIN Scanner Offline</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 700px;
    }
    input, button, select {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      font-size: 16px;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    .scan-input {
      font-weight: bold;
      font-size: 18px;
    }
    button.skip, button.empty {
      width: 48%;
      display: inline-block;
      margin: 5px 1%;
      font-weight: bold;
    }
    button.delete-btn {
      background-color: #d9534f;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 3px;
    }
    button.delete-btn:hover {
      background-color: #c9302c;
    }
  </style>
</head>
<body>

<h2>VIN Allocation (Offline)</h2>

<!-- Mode Selection -->
<div>
  <label>Select Mode:</label>
  <select id="modeSelect" onchange="handleModeChange()">
    <option value="">-- Select --</option>
    <option value="yard">Yard Mapping</option>
    <option value="individual">Individual VIN Parking</option>
  </select>
</div>

<!-- Yard Mapping Section -->
<div id="yardMappingSection" style="display:none; margin-top:20px;">
  <div>
    <label>Enter Yard Name:</label>
    <input type="text" id="yard" autocomplete="off" />
    <label>Enter Sub Yard:</label>
    <input type="text" id="subYard" autocomplete="off" />
    <label>Enter Row Name:</label>
    <input type="text" id="row" autocomplete="off" />
    <button onclick="startScanning()">Start Scanning</button>
  </div>

  <!-- Bay Display -->
  <div id="scanSection" style="display:none; margin-top: 15px;">
    <label>Current Bay: <span id="bayDisplay">1</span></label>

    <div id="vinInputSection" style="display:none; margin-top: 15px;">
      <label>Scan VIN:</label>
      <input type="text" id="vin" class="scan-input" autocomplete="off" inputmode="none" />

      <div style="margin-top:10px;">
        <button class="empty" onclick="addEmptySlot()" style="background-color:#5bc0de; color:white;">Add Empty Slot</button>
      </div>

      <button onclick="completeScanning()" style="margin-top:10px;">Complete Scanning & Export</button>
      <button onclick="resetAll()" style="background-color: red; color: white; margin-top:10px;">Reset All</button>
    </div>
  </div>
</div>

<!-- Individual VIN Parking Section -->
<div id="individualVinSection" style="display:none; margin-top: 20px;">
  <label>Yard:</label>
  <input type="text" id="indYard" autocomplete="off" />
  <label>Bay:</label>
  <input type="text" id="indBay" autocomplete="off" />
  <label>Slot:</label>
  <input type="text" id="indSlot" autocomplete="off" />
  <label>VIN:</label>
  <input type="text" id="indVin" autocomplete="off" />
  <button onclick="submitIndividualVin()" style="margin-top:10px;">Submit VIN</button>
  <button onclick="completeScanning()" style="margin-top:10px;">Export Data</button>
  <button onclick="resetAll()" style="background-color: red; color: white; margin-top:10px;">Reset All</button>
</div>

<!-- VIN Table -->
<table id="vinTable" style="display:none;">
  <thead>
    <tr>
      <th>#</th>
      <th>Yard</th>
      <th>Sub Yard</th>
      <th>Row</th>
      <th>Bay</th>
      <th>Slot</th>
      <th>VIN</th>
      <th>Time</th>
      <th>Delete</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
  var mode = "";
  var yardName = "";
  var subYardName = "";
  var rowName = "";
  var bayCount = 1;
  var slotCount = 1;
  var vinCount = 1;
  var records = [];

  var yardInput = document.getElementById('yard');
  var vinInput = document.getElementById('vin');
  var tableBody = document.getElementById('tableBody');

  function handleModeChange() {
    mode = document.getElementById("modeSelect").value;
    resetAll(false);
    document.getElementById("yardMappingSection").style.display = mode === "yard" ? "block" : "none";
    document.getElementById("individualVinSection").style.display = mode === "individual" ? "block" : "none";
    if (mode) {
      document.getElementById("modeSelect").disabled = true;
    }
  }

  function startScanning() {
    yardName = yardInput.value.trim();
    subYardName = document.getElementById("subYard").value.trim();
    rowName = document.getElementById("row").value.trim();

    if (!yardName || !subYardName || !rowName) {
      alert("Please enter Yard, Sub Yard and Row.");
      return;
    }

    yardInput.disabled = true;
    document.getElementById("subYard").disabled = true;
    document.getElementById("row").disabled = true;

    bayCount = 1;
    slotCount = 1;
    document.getElementById("bayDisplay").innerText = bayCount;

    document.getElementById('scanSection').style.display = 'block';
    document.getElementById('vinInputSection').style.display = 'block';
    document.getElementById('vinTable').style.display = 'table';
    vinInput.focus();
  }

  vinInput.oninput = function () {
    var vinVal = vinInput.value.trim();
    if (vinVal === "") return;

    if (vinInput._timeout) clearTimeout(vinInput._timeout);
    vinInput._timeout = setTimeout(function () {
      var vin = vinInput.value.trim();
      if (vin !== "") {
        addVinRecord(vin);
        vinInput.value = "";
      }
    }, 150);
  };

  function addVinRecord(vin) {
    var now = new Date();
    var timestamp = now.toLocaleString();

    var record = {
      id: vinCount,
      yard: yardName,
      subYard: subYardName,
      row: rowName,
      bay: bayCount,
      slot: slotCount,
      vin: vin,
      time: timestamp
    };

    records.push(record);
    rebuildTableWithDeleteButton();

    vinCount++;
    slotCount++;
    bayCount++;
    document.getElementById("bayDisplay").innerText = bayCount;
    vinInput.focus();
  }

  function addEmptySlot() {
    if (!yardName || !subYardName || !rowName) {
      alert("Please set Yard, Sub Yard, and Row first.");
      return;
    }

    var now = new Date();
    var timestamp = now.toLocaleString();

    var record = {
      id: vinCount,
      yard: yardName,
      subYard: subYardName,
      row: rowName,
      bay: bayCount,
      slot: slotCount,
      vin: "(Empty)",
      time: timestamp
    };

    records.push(record);
    rebuildTableWithDeleteButton();

    vinCount++;
    slotCount++;
    bayCount++;
    document.getElementById("bayDisplay").innerText = bayCount;
    vinInput.focus();
  }

  function rebuildTableWithDeleteButton() {
    tableBody.innerHTML = "";
    records.forEach((record, index) => {
      var row = document.createElement('tr');
      var deleteCell = index === records.length - 1
        ? `<button class="delete-btn" onclick="deleteRecord(${record.id})">Delete</button>`
        : "";
      row.innerHTML = `<td>${record.id}</td>
