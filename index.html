<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>VIN Scanner</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      color: #2c3e50;
      font-size: 14px;
      line-height: 1.4;
      overflow-x: hidden;
    }
    
    .header {
      background: #34495e;
      color: white;
      padding: 12px 16px;
      text-align: center;
      font-weight: 600;
      font-size: 16px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .container {
      padding: 16px;
      margin-bottom: 8px;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #34495e;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      color: #555;
      font-size: 13px;
    }
    
    input, textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.2s;
      background: #fff;
      resize: none;
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: #3498db;
    }
    
    .scan-input {
      font-weight: 600;
      border-color: #27ae60;
      background: #f8fff8;
    }
    
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 12px;
      text-align: center;
      display: block;
    }
    
    .btn-primary { background: #3498db; color: white; }
    .btn-success { background: #27ae60; color: white; }
    .btn-warning { background: #f39c12; color: white; }
    .btn-danger { background: #e74c3c; color: white; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-sync { background: #9b59b6; color: white; }
    
    .btn:active {
      transform: translateY(1px);
      opacity: 0.8;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .direction-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .direction-btn {
      padding: 12px;
      border: 2px solid #ddd;
      background: white;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .direction-btn.active {
      background: #27ae60;
      color: white;
      border-color: #27ae60;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .stat-card {
      text-align: center;
      padding: 12px 8px;
      background: #ecf0f1;
      border-radius: 8px;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: #2c3e50;
    }
    
    .stat-label {
      font-size: 11px;
      color: #7f8c8d;
      margin-top: 4px;
    }
    
    .current-direction {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      margin-bottom: 16px;
    }
    
    .message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-weight: 500;
      text-align: center;
    }
    
    .error-msg {
      background: #ffebee;
      color: #c62828;
      border-left: 4px solid #f44336;
    }
    
    .success-msg {
      background: #e8f5e8;
      color: #2e7d32;
      border-left: 4px solid #4caf50;
    }
    
    .warning-msg {
      background: #fff3cd;
      color: #856404;
      border-left: 4px solid #ffc107;
    }
    
    .hidden {
      display: none !important;
    }
    
    .table-container {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    
    .table-header {
      background: #34495e;
      color: white;
      padding: 12px 16px;
      font-weight: 600;
      font-size: 14px;
    }
    
    .table-content {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .record-item {
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
      position: relative;
    }
    
    .record-item:last-child {
      border-bottom: none;
    }
    
    .record-item.empty {
      background: #fff8e1;
    }
    
    .record-item.reverse {
      background: #ffebee;
    }
    
    .record-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .record-id {
      background: #3498db;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
    }
    
    .record-vin {
      font-weight: 700;
      font-size: 15px;
      margin: 4px 0;
      color: #2c3e50;
    }
    
    .record-vin.empty-slot {
      color: #f39c12;
      font-style: italic;
    }
    
    .record-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 12px;
      color: #666;
    }
    
    .record-location {
      font-weight: 500;
    }
    
    .delete-btn {
      background: #e74c3c;
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .action-buttons {
      position: sticky;
      bottom: 0;
      background: white;
      padding: 16px;
      border-top: 1px solid #eee;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      max-width: 400px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #34495e;
      text-align: center;
    }
    
    .sync-status {
      padding: 8px;
      border-radius: 6px;
      margin: 8px 0;
      font-size: 13px;
      text-align: center;
    }
    
    .sync-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .sync-success {
      background: #d4edda;
      color: #155724;
    }
    
    .sync-error {
      background: #f8d7da;
      color: #721c24;
    }
    
    /* Mobile optimizations for Android 4 */
    @media (max-width: 320px) {
      .container { padding: 12px; }
      .card { padding: 12px; }
      .btn { padding: 12px; font-size: 14px; }
      .stats-grid { grid-template-columns: 1fr; }
      .record-details { grid-template-columns: 1fr; }
      .action-buttons { grid-template-columns: 1fr; }
      .direction-controls { grid-template-columns: 1fr; }
    }
    
    @media (min-width: 321px) and (max-width: 480px) {
      .action-buttons { grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    }
  </style>
</head>

<body>

<div class="header">
  üì± VIN Scanner - <span id="deviceIdHeader">Scanner</span>
</div>

<div class="container">
  <!-- Configuration Section -->
  <div class="card" id="configSection">
    <div class="section-title">üè≠ Setup</div>
    
    <div class="form-group">
      <label>Yard Name</label>
      <input type="text" id="yard" placeholder="e.g., H" maxlength="10" />
    </div>
    
    <div class="form-group">
      <label>Sub Yard</label>
      <input type="text" id="subYard" placeholder="e.g., H2" maxlength="10" />
    </div>
    
    <div class="form-group">
      <label>Row Name</label>
      <input type="text" id="row" placeholder="e.g., 1" maxlength="10" />
    </div>
    
    <button onclick="startScanning()" class="btn btn-success">üöÄ Start Scanning</button>
  </div>

  <!-- Scanning Section -->
  <div class="card hidden" id="scanSection">
    <div class="section-title">üîç <span id="currentRowText">Scanning</span></div>
    
    <div class="current-direction">
      <div id="currentDirectionText">‚û°Ô∏è Forward Direction</div>
    </div>

    <div class="direction-controls">
      <button id="forwardBtn" class="direction-btn active" onclick="switchDirection('F')">
        ‚û°Ô∏è Forward
      </button>
      <button id="reverseBtn" class="direction-btn" onclick="switchDirection('R')">
        ‚¨ÖÔ∏è Reverse
      </button>
    </div>

    <div class="form-group">
      <label>üì± Scan VIN</label>
      <input type="text" id="vin" class="scan-input" placeholder="Scan or enter VIN" oninput="handleVinInput()" />
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="currentRowCount">0</div>
        <div class="stat-label">Current Row</div>
      </div>
      <div class="stat-card">
        <button onclick="addEmptySlot()" class="btn btn-warning" style="margin: 0; font-size: 12px; padding: 8px;">
          üìç Empty
        </button>
      </div>
      <div class="stat-card">
        <button onclick="nextRow()" class="btn btn-info" style="margin: 0; font-size: 12px; padding: 8px;">
          ‚úÖ Done
        </button>
      </div>
    </div>
  </div>

  <!-- Message Area -->
  <div id="messageArea"></div>

  <!-- Statistics Section -->
  <div class="card hidden" id="statsSection">
    <div class="section-title">üìä Statistics</div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalRecords">0</div>
        <div class="stat-label">Total Items</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="vinRecords">0</div>
        <div class="stat-label">VINs</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="emptyRecords">0</div>
        <div class="stat-label">Empty Slots</div>
      </div>
    </div>
  </div>

  <!-- Records Section -->
  <div class="table-container hidden" id="recordsSection">
    <div class="table-header">üìã Recent Records</div>
    <div class="table-content">
      <div id="recordsList">
        <!-- Records will be dynamically added here -->
      </div>
    </div>
  </div>

</div>

<!-- Sync Modal -->
<div id="syncModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-title">‚òÅÔ∏è Sync to GitHub</div>
    
    <div class="form-group">
      <label>GitHub Personal Access Token (PAT)</label>
      <textarea id="patToken" rows="3" placeholder="Paste your GitHub PAT here..."></textarea>
      <div style="font-size: 12px; color: #666; margin-top: 4px;">
        <strong>üìÅ Files will be saved to:</strong> /yard_scans/ folder<br>
        <strong>üîë Required permissions:</strong> repo access to Yard_details<br>
        <strong>üì± Device:</strong> <span id="deviceInfo">Scanner</span>
      </div>
    </div>
    
    <div id="syncStatus"></div>
    
    <button id="syncBtn" onclick="syncToGitHub()" class="btn btn-sync">‚òÅÔ∏è Sync to GitHub</button>
    <button onclick="hideSyncModal()" class="btn btn-danger">‚ùå Cancel</button>
  </div>
</div>

<!-- Action Buttons -->
<div class="action-buttons">
  <button onclick="showSyncModal()" class="btn btn-sync">‚òÅÔ∏è Sync</button>
  <button onclick="exportLocalCSV()" class="btn btn-info">üìÅ Export</button>
  <button onclick="resetAll()" class="btn btn-danger">üîÑ Reset</button>
</div>

<script>
    // Generate/get device ID
    function getDeviceId() {
      var deviceId;
      try {
        deviceId = localStorage ? localStorage.getItem('vin-scanner-device-id') : null;
        if (!deviceId) {
          deviceId = 'device-' + Math.random().toString(36).substr(2, 9);
          if (localStorage) {
            localStorage.setItem('vin-scanner-device-id', deviceId);
          }
        }
      } catch (e) {
        deviceId = 'device-' + Math.random().toString(36).substr(2, 9);
      }
      return deviceId;
    }

    // Global state
    var appState = {
      yardName: "",
      subYardName: "",
      rowName: "",
      currentDirection: "F",
      vinCount: 1,
      records: [],
      currentRowRecords: [],
      isScanning: false,
      deviceId: getDeviceId()
    };

    // GitHub configuration
    var githubConfig = {
      owner: 'BhavyaKrishnanRNAIPL',
      repo: 'Yard_details',
      branch: 'main',
      token: ''
    };

    var vinInputTimeout;

    // Get user-friendly device name
    function getUserFriendlyDeviceName() {
      return 'Scanner-' + appState.deviceId.substring(7).toUpperCase();
    }

    // Handle VIN input
    function handleVinInput() {
      var vinInput = document.getElementById('vin');
      if (vinInputTimeout) clearTimeout(vinInputTimeout);
      
      vinInputTimeout = setTimeout(function() {
        var inputValue = vinInput.value.trim().toUpperCase();
        if (inputValue !== "") {
          var extractedVin = extractVIN(inputValue);
          if (extractedVin && validateVIN(extractedVin)) {
            addVinRecord(extractedVin);
            vinInput.value = "";
            showMessage("‚úì VIN " + extractedVin + " added", "success");
          } else if (inputValue !== "") {
            showMessage("‚ùå Invalid VIN format", "error");
          }
        }
      }, 300);
    }

    // Extract VIN from input
    function extractVIN(scannedData) {
      try {
        var hashIndex = scannedData.indexOf('#');
        if (hashIndex !== -1 && scannedData.length >= hashIndex + 18) {
          var possibleVin = scannedData.substring(hashIndex + 1, hashIndex + 18);
          if (validateVIN(possibleVin)) {
            return possibleVin.toUpperCase();
          }
        }
        
        if (scannedData.length === 17 && validateVIN(scannedData)) {
          return scannedData;
        }
        
        for (var i = 0; i <= scannedData.length - 17; i++) {
          var possibleVin = scannedData.substring(i, i + 17);
          if (validateVIN(possibleVin)) {
            return possibleVin.toUpperCase();
          }
        }
        return null;
      } catch (e) {
        return null;
      }
    }

    // Validate VIN
    function validateVIN(vin) {
      if (!vin || vin.length !== 17) return false;
      var invalidChars = ['I', 'O', 'Q'];
      for (var i = 0; i < invalidChars.length; i++) {
        if (vin.indexOf(invalidChars[i]) !== -1) return false;
      }
      var validChars = 'ABCDEFGHJKLMNPRSTUVWXYZ0123456789';
      for (var i = 0; i < vin.length; i++) {
        if (validChars.indexOf(vin.charAt(i)) === -1) return false;
      }
      return true;
    }

    // Switch direction
    function switchDirection(dir) {
      appState.currentDirection = dir;
      var forwardBtn = document.getElementById('forwardBtn');
      var reverseBtn = document.getElementById('reverseBtn');
      var currentDirDisplay = document.getElementById('currentDirectionText');
      
      if (dir === 'F') {
        forwardBtn.classList.add('active');
        reverseBtn.classList.remove('active');
        currentDirDisplay.textContent = '‚û°Ô∏è Forward Direction';
      } else {
        reverseBtn.classList.add('active');
        forwardBtn.classList.remove('active');
        currentDirDisplay.textContent = '‚¨ÖÔ∏è Reverse Direction';
      }
    }

    // Start scanning
    function startScanning() {
      var yard = document.getElementById('yard');
      var subYard = document.getElementById('subYard');
      var row = document.getElementById('row');

      appState.yardName = yard.value.trim();
      appState.subYardName = subYard.value.trim();
      appState.rowName = row.value.trim();

      if (!appState.yardName || !appState.subYardName || !appState.rowName) {
        showMessage("‚ùå Please fill all fields", "error");
        return;
      }

      yard.disabled = true;
      subYard.disabled = true;
      row.disabled = true;

      appState.currentRowRecords = [];
      appState.currentDirection = 'F';
      appState.isScanning = true;

      document.getElementById('configSection').classList.add('hidden');
      document.getElementById('scanSection').classList.remove('hidden');
      document.getElementById('recordsSection').classList.remove('hidden');
      document.getElementById('statsSection').classList.remove('hidden');

      switchDirection('F');
      updateDisplay();
      
      document.getElementById('currentRowText').textContent = 'Row: ' + appState.rowName;
      document.getElementById('vin').focus();

      showMessage("‚úì Scanning started for Row " + appState.rowName, "success");
    }

    // Add VIN record
    function addVinRecord(vin) {
      var now = new Date();
      var record = {
        id: appState.vinCount,
        yard: appState.yardName,
        subYard: appState.subYardName,
        row: appState.rowName,
        bay: 0,
        slot: appState.currentRowRecords.length + 1,
        vin: vin,
        time: formatDateTime(now),
        direction: appState.currentDirection,
        isEmpty: false,
        deviceId: appState.deviceId
      };

      appState.currentRowRecords.push(record);
      appState.vinCount++;
      
      updateDisplay();
      updateRecordsList();
      
      document.getElementById('vin').focus();
    }

    // Add empty slot
    function addEmptySlot() {
      var now = new Date();
      var record = {
        id: appState.vinCount,
        yard: appState.yardName,
        subYard: appState.subYardName,
        row: appState.rowName,
        bay: 0,
        slot: appState.currentRowRecords.length + 1,
        vin: "(Empty)",
        time: formatDateTime(now),
        direction: appState.currentDirection,
        isEmpty: true,
        deviceId: appState.deviceId
      };

      appState.currentRowRecords.push(record);
      appState.vinCount++;
      
      updateDisplay();
      updateRecordsList();
      
      document.getElementById('vin').focus();
      showMessage("üìç Empty slot marked", "success");
    }

    // Complete row
    function nextRow() {
      if (appState.currentRowRecords.length === 0) {
        showMessage("‚ùå No records to complete", "error");
        return;
      }

      calculateBayAssignments();

      for (var i = 0; i < appState.currentRowRecords.length; i++) {
        appState.records.push(appState.currentRowRecords[i]);
      }

      var totalRecords = appState.currentRowRecords.length;
      showMessage("‚úÖ Row " + appState.rowName + " completed (" + totalRecords + " items)", "success");

      // Reset for new row
      var yard = document.getElementById('yard');
      var subYard = document.getElementById('subYard');
      var row = document.getElementById('row');
      
      yard.disabled = false;
      subYard.disabled = false;
      row.disabled = false;
      row.value = "";
      
      document.getElementById('configSection').classList.remove('hidden');
      document.getElementById('scanSection').classList.add('hidden');
      
      appState.isScanning = false;
      appState.currentRowRecords = [];
      
      updateDisplay();
      updateRecordsList();
      
      row.focus();
    }

    // Calculate bay assignments
    function calculateBayAssignments() {
      var forwardRecords = [];
      var reverseRecords = [];

      for (var i = 0; i < appState.currentRowRecords.length; i++) {
        if (appState.currentRowRecords[i].direction === 'F') {
          forwardRecords.push(appState.currentRowRecords[i]);
        } else {
          reverseRecords.push(appState.currentRowRecords[i]);
        }
      }

      var totalRecords = appState.currentRowRecords.length;

      for (var i = 0; i < forwardRecords.length; i++) {
        forwardRecords[i].bay = i + 1;
      }

      var reverseBay = totalRecords;
      for (var i = 0; i < reverseRecords.length; i++) {
        reverseRecords[i].bay = reverseBay--;
      }
    }

    // Update display
    function updateDisplay() {
      var allRecords = appState.records.concat(appState.currentRowRecords);
      var total = allRecords.length;
      var vinCount = 0;
      var emptyCount = 0;
      
      for (var i = 0; i < allRecords.length; i++) {
        if (allRecords[i].isEmpty) {
          emptyCount++;
        } else {
          vinCount++;
        }
      }

      var totalElem = document.getElementById('totalRecords');
      var vinElem = document.getElementById('vinRecords');
      var emptyElem = document.getElementById('emptyRecords');
      var currentElem = document.getElementById('currentRowCount');

      if (totalElem) totalElem.textContent = total;
      if (vinElem) vinElem.textContent = vinCount;
      if (emptyElem) emptyElem.textContent = emptyCount;
      if (currentElem) currentElem.textContent = appState.currentRowRecords.length;
    }

    // Update records list
    function updateRecordsList() {
      var container = document.getElementById('recordsList');
      if (!container) return;
      
      container.innerHTML = '';

      var allRecords = appState.records.concat(appState.currentRowRecords);
      
      for (var i = allRecords.length - 1; i >= 0; i--) {
        var record = allRecords[i];
        var div = document.createElement('div');
        div.className = 'record-item';
        
        if (record.isEmpty) {
          div.classList.add('empty');
        } else if (record.direction === 'R') {
          div.classList.add('reverse');
        }

        var isLastCurrent = appState.isScanning && 
                           i >= appState.records.length && 
                           i === allRecords.length - 1;

        div.innerHTML = 
          '<div class="record-header">' +
            '<div class="record-id">' + record.id + '</div>' +
            (isLastCurrent ? '<button class="delete-btn" onclick="deleteLastRecord()">√ó</button>' : '') +
          '</div>' +
          '<div class="record-vin' + (record.isEmpty ? ' empty-slot' : '') + '">' + record.vin + '</div>' +
          '<div class="record-details">' +
            '<div class="record-location">' + record.yard + '/' + record.subYard + '/' + record.row + 
            (record.bay > 0 ? '/' + record.bay : '') + '/' + record.slot + '</div>' +
            '<div>' + record.direction + ' ‚Ä¢ ' + record.time.split(' ')[1] + '</div>' +
          '</div>';
          
        container.appendChild(div);
      }
    }

    // Delete last record
    function deleteLastRecord() {
      if (appState.currentRowRecords.length === 0) return;

      appState.currentRowRecords.pop();
      appState.vinCount--;

      updateDisplay();
      updateRecordsList();
      
      document.getElementById('vin').focus();
      showMessage("üóëÔ∏è Last record deleted", "success");
    }

    // Show sync modal
    function showSyncModal() {
      if (appState.records.length === 0) {
        showMessage("‚ùå No data to sync. Complete at least one row first.", "error");
        return;
      }

      document.getElementById('syncModal').classList.remove('hidden');
      document.getElementById('deviceInfo').textContent = getUserFriendlyDeviceName();
      document.getElementById('patToken').focus();
    }

    // Hide sync modal
    function hideSyncModal() {
      document.getElementById('syncModal').classList.add('hidden');
      document.getElementById('patToken').value = '';
      document.getElementById('syncStatus').innerHTML = '';
    }

    // Sync to GitHub
    function syncToGitHub() {
      var token = document.getElementById('patToken').value.trim();
      var statusDiv = document.getElementById('syncStatus');
      
      if (!token) {
        statusDiv.innerHTML = '<div class="sync-status sync-error">‚ùå Please enter your GitHub PAT</div>';
        return;
      }

      if (appState.records.length === 0) {
        statusDiv.innerHTML = '<div class="sync-status sync-error">‚ùå No data to sync</div>';
        return;
      }

      // Show pending status
      statusDiv.innerHTML = '<div class="sync-status sync-pending">‚è≥ Syncing data to GitHub...</div>';
      
      var syncBtn = document.getElementById('syncBtn');
      syncBtn.disabled = true;
      syncBtn.textContent = '‚è≥ Syncing...';

      // Prepare data
      var now = new Date();
      var timestamp = now.toISOString().replace(/[:.]/g, '-');
      var fileName = 'yard_scans/' + appState.deviceId + '-' + timestamp + '.json';
      
      var syncData = {
        deviceId: appState.deviceId,
        deviceName: getUserFriendlyDeviceName(),
        timestamp: now.toISOString(),
        scanSession: {
          startTime: now.toISOString(),
          totalRows: getUniqueRowsCount(),
          totalRecords: appState.records.length
        },
        summary: {
          totalVins: appState.records.filter(function(r) { return !r.isEmpty; }).length,
          totalEmpty: appState.records.filter(function(r) { return r.isEmpty; }).length,
          yards: getUniqueYards(),
          rows: getUniqueRows()
        },
        records: appState.records
      };

      var content = btoa(JSON.stringify(syncData, null, 2));
      
      var apiUrl = 'https://api.github.com/repos/' + githubConfig.owner + '/' + githubConfig.repo + '/contents/' + fileName;
      
      // Make GitHub API call
      var xhr = new XMLHttpRequest();
      xhr.open('PUT', apiUrl, true);
      xhr.setRequestHeader('Authorization', 'token ' + token);
      xhr.setRequestHeader('Content-Type', 'application/json');
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          syncBtn.disabled = false;
          syncBtn.textContent = '‚òÅÔ∏è Sync to GitHub';
          
          if (xhr.status === 201) {
            statusDiv.innerHTML = '<div class="sync-status sync-success">‚úÖ Successfully synced ' + appState.records.length + ' records!</div>';
            showMessage("‚òÅÔ∏è Data synced to GitHub successfully!", "success");
            
            // Auto-close modal after 2 seconds
            setTimeout(function() {
              hideSyncModal();
            }, 2000);
          } else {
            var errorMsg = 'Sync failed';
            try {
              var response = JSON.parse(xhr.responseText);
              errorMsg = response.message || errorMsg;
            } catch (e) {}
            
            statusDiv.innerHTML = '<div class="sync-status sync-error">‚ùå ' + errorMsg + '</div>';
            showMessage("‚ùå Sync failed: " + errorMsg, "error");
          }
        }
      };
      
      xhr.onerror = function() {
        syncBtn.disabled = false;
        syncBtn.textContent = '‚òÅÔ∏è Sync to GitHub';
        statusDiv.innerHTML = '<div class="sync-status sync-error">‚ùå Network error</div>';
        showMessage("‚ùå Network error during sync", "error");
      };
      
      xhr.send(JSON.stringify({
        message: 'VIN scan data from ' + getUserFriendlyDeviceName() + ' at ' + formatDateTime(now),
        content: content,
        branch: githubConfig.branch
      }));
    }

    // Get unique rows count
    function getUniqueRowsCount() {
      var uniqueRows = {};
      for (var i = 0; i < appState.records.length; i++) {
        var key = appState.records[i].yard + '/' + appState.records[i].subYard + '/' + appState.records[i].row;
        uniqueRows[key] = true;
      }
      return Object.keys(uniqueRows).length;
    }

    // Get unique yards
    function getUniqueYards() {
      var yards = {};
      for (var i = 0; i < appState.records.length; i++) {
        var key = appState.records[i].yard + '/' + appState.records[i].subYard;
        yards[key] = (yards[key] || 0) + 1;
      }
      return yards;
    }

    // Get unique rows
    function getUniqueRows() {
      var rows = {};
      for (var i = 0; i < appState.records.length; i++) {
        var key = appState.records[i].yard + '/' + appState.records[i].subYard + '/' + appState.records[i].row;
        rows[key] = (rows[key] || 0) + 1;
      }
      return rows;
    }

    // Export local CSV
    function exportLocalCSV() {
      if (appState.records.length === 0) {
        showMessage("‚ùå No data to export", "error");
        return;
      }

      var csv = "S.No,Yard,Sub Yard,Row,Bay,Slot,VIN,Timestamp,Direction,DeviceID\n";
      
      for (var i = 0; i < appState.records.length; i++) {
        var record = appState.records[i];
        csv += record.id + ',' + record.yard + ',' + record.subYard + ',' + record.row + ',' + 
               record.bay + ',' + record.slot + ',' + record.vin + ',' + record.time + ',' + 
               record.direction + ',' + record.deviceId + '\n';
      }

      try {
        var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        var link = document.createElement("a");
        var fileName = "VIN_Export_" + getUserFriendlyDeviceName() + "_" + Date.now() + ".csv";

        if (window.URL && window.URL.createObjectURL) {
          var url = window.URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute("download", fileName);
          link.style.visibility = "hidden";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
        }

        showMessage("üìÅ CSV exported locally!", "success");
      } catch (e) {
        showMessage("‚ùå Export failed", "error");
      }
    }

    // Reset all data
    function resetAll() {
      if (!confirm("Reset all data? This cannot be undone.")) return;

      appState = {
        yardName: "",
        subYardName: "",
        rowName: "",
        currentDirection: "F",
        vinCount: 1,
        records: [],
        currentRowRecords: [],
        isScanning: false,
        deviceId: getDeviceId()
      };

      var inputs = ['yard', 'subYard', 'row', 'vin'];
      for (var i = 0; i < inputs.length; i++) {
        var element = document.getElementById(inputs[i]);
        if (element) {
          element.value = "";
          element.disabled = false;
        }
      }

      document.getElementById('configSection').classList.remove('hidden');
      document.getElementById('scanSection').classList.add('hidden');
      document.getElementById('recordsSection').classList.add('hidden');
      document.getElementById('statsSection').classList.add('hidden');

      updateDisplay();
      updateRecordsList();

      showMessage("üîÑ System reset complete", "success");
    }

    // Format date time
    function formatDateTime(date) {
      var year = date.getFullYear();
      var month = (date.getMonth() + 1 < 10 ? '0' : '') + (date.getMonth() + 1);
      var day = (date.getDate() < 10 ? '0' : '') + date.getDate();
      var hours = (date.getHours() < 10 ? '0' : '') + date.getHours();
      var minutes = (date.getMinutes() < 10 ? '0' : '') + date.getMinutes();
      var seconds = (date.getSeconds() < 10 ? '0' : '') + date.getSeconds();
      
      return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;
    }

    // Show message
    function showMessage(message, type) {
      var targetArea = document.getElementById('messageArea');
      if (!targetArea) return;

      var className = "message ";
      if (type === "error") {
        className += "error-msg";
      } else if (type === "warning") {
        className += "warning-msg";
      } else {
        className += "success-msg";
      }

      targetArea.innerHTML = '<div class="' + className + '">' + message + '</div>';

      setTimeout(function() {
        if (targetArea) {
          targetArea.innerHTML = "";
        }
      }, 3000);
    }

    // Initialize on load
    function initializeApp() {
      updateDisplay();
      updateRecordsList();
      
      // Update header with device name
      var headerElement = document.getElementById('deviceIdHeader');
      var deviceInfoElement = document.getElementById('deviceInfo');
      
      if (headerElement) {
        headerElement.textContent = getUserFriendlyDeviceName();
      }
      if (deviceInfoElement) {
        deviceInfoElement.textContent = getUserFriendlyDeviceName();
      }
      
      // Show device info message
      showMessage("üì± Device: " + getUserFriendlyDeviceName() + " | Files sync to: /yard_scans/ folder", "warning");
    }

    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
</script>

</body>
</html>
