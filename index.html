<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>VIN Scanner Offline</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 700px;
    }
    input, button, select {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      font-size: 16px;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    .scan-input {
      font-weight: bold;
      font-size: 18px;
    }
    button.skip, button.empty {
      width: 48%;
      display: inline-block;
      margin: 5px 1%;
      font-weight: bold;
    }
    button.delete-btn {
      background-color: #d9534f;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 3px;
    }
    button.delete-btn:hover {
      background-color: #c9302c;
    }
  </style>
</head>
<body>

<h2>VIN Allocation (Offline)</h2>

<!-- Mode Selection -->
<div>
  <label>Select Mode:</label>
  <select id="modeSelect">
    <option value="">-- Select --</option>
    <option value="yard">Yard Mapping</option>
    <option value="individual">Individual VIN Parking</option>
  </select>
</div>

<!-- Yard Mapping Section -->
<div id="yardMappingSection" style="display:none; margin-top:20px;">
  <div>
    <label>Enter Yard Name:</label>
    <input type="text" id="yard" autocomplete="off" />
    <label>Enter Sub Yard:</label>
    <input type="text" id="subYard" autocomplete="off" />
    <label>Enter Row Name:</label>
    <input type="text" id="row" autocomplete="off" />
    <button onclick="startScanning()">Start Scanning</button>
  </div>

  <!-- Bay Display -->
  <div id="scanSection" style="display:none; margin-top: 15px;">
    <label>Current Bay: <span id="bayDisplay">1</span></label>

    <div id="vinInputSection" style="display:none; margin-top: 15px;">
      <label>Scan VIN:</label>
      <input type="text" id="vin" class="scan-input" autocomplete="off" inputmode="none" />

      <div style="margin-top:10px;">
        <button class="empty" onclick="addEmptySlot()" style="background-color:#5bc0de; color:white;">Add Empty Slot</button>
      </div>

      <button onclick="completeScanning()" style="margin-top:10px;">Complete Scanning & Export</button>
      <button onclick="resetAll()" style="background-color: red; color: white; margin-top:10px;">Reset All</button>
    </div>
  </div>
</div>

<!-- Individual VIN Parking Section -->
<div id="individualVinSection" style="display:none; margin-top: 20px;">
  <label>Yard:</label>
  <input type="text" id="indYard" autocomplete="off" />
  <label>Bay:</label>
  <input type="text" id="indBay" autocomplete="off" />
  <label>Slot:</label>
  <input type="text" id="indSlot" autocomplete="off" />
  <label>VIN:</label>
  <input type="text" id="indVin" autocomplete="off" />
  <button onclick="submitIndividualVin()" style="margin-top:10px;">Submit VIN</button>
  <button onclick="completeScanning()" style="margin-top:10px;">Export Data</button>
  <button onclick="resetAll()" style="background-color: red; color: white; margin-top:10px;">Reset All</button>
</div>

<!-- VIN Table -->
<table id="vinTable" style="display:none;">
  <thead>
    <tr>
      <th>#</th>
      <th>Yard</th>
      <th>Sub Yard</th>
      <th>Row</th>
      <th>Bay</th>
      <th>Slot</th>
      <th>VIN</th>
      <th>Time</th>
      <th>Delete</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", function () {
  let mode = "";
  let yardName = "";
  let subYardName = "";
  let rowName = "";
  let bayCount = 1;
  let slotCount = 1;
  let vinCount = 1;
  let records = [];

  const yardInput = document.getElementById('yard');
  const subYardInput = document.getElementById('subYard');
  const rowInput = document.getElementById('row');
  const vinInput = document.getElementById('vin');
  const bayDisplay = document.getElementById('bayDisplay');
  const tableBody = document.getElementById('tableBody');

  document.getElementById("modeSelect").addEventListener("change", handleModeChange);

  function handleModeChange() {
    mode = document.getElementById("modeSelect").value;
    resetAll(false);
    document.getElementById("yardMappingSection").style.display = mode === "yard" ? "block" : "none";
    document.getElementById("individualVinSection").style.display = mode === "individual" ? "block" : "none";
    if (mode) {
      document.getElementById("modeSelect").disabled = true;
    }
  }

  window.startScanning = function () {
    yardName = yardInput.value.trim();
    subYardName = subYardInput.value.trim();
    rowName = rowInput.value.trim();

    if (!yardName || !subYardName || !rowName) {
      alert("Please enter Yard, Sub Yard and Row.");
      return;
    }

    yardInput.disabled = true;
    subYardInput.disabled = true;
    rowInput.disabled = true;

    bayCount = 1;
    slotCount = 1;
    bayDisplay.innerText = bayCount;

    document.getElementById('scanSection').style.display = 'block';
    document.getElementById('vinInputSection').style.display = 'block';
    document.getElementById('vinTable').style.display = 'table';
    vinInput.focus();
  }

  vinInput.addEventListener("input", function () {
    if (vinInput._timeout) clearTimeout(vinInput._timeout);
    vinInput._timeout = setTimeout(() => {
      const vin = vinInput.value.trim();
      if (vin !== "") {
        addVinRecord(vin);
        vinInput.value = "";
      }
    }, 150);
  });

  function addVinRecord(vin) {
    const now = new Date();
    const timestamp = now.toLocaleString();

    const record = {
      id: vinCount,
      yard: yardName,
      subYard: subYardName,
      row: rowName,
      bay: bayCount,
      slot: slotCount,
      vin,
      time: timestamp
    };

    records.push(record);
    rebuildTable();
    vinCount++;
    slotCount++;
    bayCount++;
    bayDisplay.innerText = bayCount;
    vinInput.focus();
  }

  window.addEmptySlot = function () {
    const now = new Date();
    const timestamp = now.toLocaleString();

    const record = {
      id: vinCount,
      yard: yardName,
      subYard: subYardName,
      row: rowName,
      bay: bayCount,
      slot: slotCount,
      vin: "(Empty)",
      time: timestamp
    };

    records.push(record);
    rebuildTable();
    vinCount++;
    slotCount++;
    bayCount++;
    bayDisplay.innerText = bayCount;
    vinInput.focus();
  }

  function rebuildTable() {
    tableBody.innerHTML = "";
    records.forEach((r, i) => {
      const row = document.createElement("tr");
      const deleteBtn = (i === records.length - 1) ?
        `<button class="delete-btn" onclick="deleteRecord(${r.id})">Delete</button>` : "";
      row.innerHTML = `
        <td>${r.id}</td>
        <td>${r.yard}</td>
        <td>${r.subYard}</td>
        <td>${r.row}</td>
        <td>${r.bay}</td>
        <td>${r.slot}</td>
        <td>${r.vin}</td>
        <td>${r.time}</td>
        <td>${deleteBtn}</td>
      `;
      tableBody.appendChild(row);
    });
    document.getElementById('vinTable').style.display = records.length > 0 ? "table" : "none";
  }
  window.deleteRecord = function (id) {
    if (records.length === 0) return;

    const lastRecord = records[records.length - 1];
    if (lastRecord.id !== id) return; // Only allow deleting the last record

    records.pop();
    vinCount--;
    slotCount--;
    bayCount--;
    bayDisplay.innerText = bayCount;

    rebuildTable();
    vinInput.focus();
  }

  window.completeScanning = function () {
    if (records.length === 0) {
      alert("No data to export.");
      return;
    }

    let csv = "S.No,Yard,Sub Yard,Row,Bay,Slot,VIN,Time\n";
    for (let r of records) {
      const vinSafe = r.vin.includes(",") ? `"${r.vin}"` : r.vin;
      csv += `${r.id},${r.yard},${r.subYard},${r.row},${r.bay},${r.slot},${vinSafe},${r.time}\n`;
    }

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    const fileName = "VIN_Export_" + new Date().toISOString().slice(0, 10) + ".csv";

    if (navigator.msSaveBlob) {
      navigator.msSaveBlob(blob, fileName);
    } else {
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", fileName);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    alert("CSV exported successfully.");
  }

  window.resetAll = function (showAlert = true) {
    mode = "";
    yardName = "";
    subYardName = "";
    rowName = "";
    bayCount = 1;
    slotCount = 1;
    vinCount = 1;
    records = [];

    yardInput.value = "";
    subYardInput.value = "";
    rowInput.value = "";
    vinInput.value = "";

    yardInput.disabled = false;
    subYardInput.disabled = false;
    rowInput.disabled = false;

    document.getElementById("indYard").value = "";
    document.getElementById("indBay").value = "";
    document.getElementById("indSlot").value = "";
    document.getElementById("indVin").value = "";

    document.getElementById('scanSection').style.display = 'none';
    document.getElementById('vinInputSection').style.display = 'none';
    document.getElementById('vinTable').style.display = 'none';
    document.getElementById('yardMappingSection').style.display = 'none';
    document.getElementById('individualVinSection').style.display = 'none';
    document.getElementById("modeSelect").disabled = false;
    document.getElementById("modeSelect").value = "";
    tableBody.innerHTML = "";
    bayDisplay.innerText = "1";

    if (showAlert) {
      alert("Reset complete. Ready to start again.");
    }
  }

  window.submitIndividualVin = function () {
    const yard = document.getElementById("indYard").value.trim();
    const bay = document.getElementById("indBay").value.trim();
    const slot = document.getElementById("indSlot").value.trim();
    const vin = document.getElementById("indVin").value.trim();

    if (!yard || !bay || !slot || !vin) {
      alert("Please fill all fields.");
      return;
    }

    const now = new Date();
    const timestamp = now.toLocaleString();

    const record = {
      id: records.length + 1,
      yard: yard,
      subYard: "-",
      row: "-",
      bay: bay,
      slot: slot,
      vin: vin,
      time: timestamp
    };

    records.push(record);
    rebuildTable();

    document.getElementById("indYard").value = "";
    document.getElementById("indBay").value = "";
    document.getElementById("indSlot").value = "";
    document.getElementById("indVin").value = "";
    document.getElementById("indYard").focus();
  }

});
</script>

